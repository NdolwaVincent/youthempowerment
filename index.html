<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Youth Empowerment Registration</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getDatabase,
      ref,
      set,
      get,
      child
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import {
      getStorage,
      ref as sRef,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBtB199eH6fONCftI_B6IDP80_0Tv2dFN8",
      authDomain: "m-sales-45b35.firebaseapp.com",
      databaseURL: "https://m-sales-45b35-default-rtdb.firebaseio.com",
      projectId: "m-sales-45b35",
      storageBucket: "m-sales-45b35.appspot.com",
      messagingSenderId: "194892525308",
      appId: "1:194892525308:web:c01af3028c85abdb97f179"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);

    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("registerForm");
      const roleSelect = document.getElementById("role");
      const seatDiv = document.getElementById("seatDiv");
      const seatSelect = document.getElementById("seat");

      // Hide or show seat based on role
      roleSelect.addEventListener("change", () => {
        if (roleSelect.value === "aspirant") {
          seatDiv.classList.remove("hidden");
          seatSelect.required = true;
        } else {
          seatDiv.classList.add("hidden");
          seatSelect.required = false;
          seatSelect.value = ""; // clear seat value if not needed
        }
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const name = document.getElementById("name").value.trim();
        const id = document.getElementById("id").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const role = roleSelect.value;
        const seat = seatSelect.value;
        const image = document.getElementById("image").files[0];

        if (!name || !id || !phone || !image || !role) {
          alert("Please fill in all required fields.");
          return;
        }

        try {
          const dbRef = ref(db);
          const checkPath = `Youth/Chama/Voting/${role === 'voter' ? 'voters' : 'aspirants'}/${phone}`;
          const existing = await get(child(dbRef, checkPath));

          if (existing.exists()) {
            alert("This phone number has already been used for registration.");
            return;
          }

          const imageRef = sRef(storage, `Youth/Chama/Voting/images/${phone}.jpg`);
          await uploadBytes(imageRef, image);
          const imageUrl = await getDownloadURL(imageRef);

          const data = { name, id, phone, imageUrl };
          if (role === "aspirant") data.seat = seat;

          await set(ref(db, checkPath), data);

          alert("Registration successful.");
          form.reset();
          seatDiv.classList.add("hidden"); // Hide seat again
        } catch (err) {
          console.error("Registration error:", err);
          alert("An error occurred during registration.");
        }
      });
    });
  </script>
</head>
<body class="bg-gradient-to-r from-indigo-200 via-blue-100 to-purple-100 min-h-screen p-4 flex items-center justify-center">
  <div class="bg-white rounded-xl shadow-xl max-w-xl w-full p-6 sm:p-10">
    <h1 class="text-2xl sm:text-3xl font-bold text-center mb-6 text-blue-700">Youth Empowerment Registration</h1>
    <form id="registerForm" class="space-y-4">
      <input class="w-full p-3 border border-gray-300 rounded" type="text" id="name" placeholder="Full Name" required />
      <input class="w-full p-3 border border-gray-300 rounded" type="text" id="id" placeholder="National ID" required />
      <input class="w-full p-3 border border-gray-300 rounded" type="tel" id="phone" placeholder="Phone Number" required />

      <select id="role" class="w-full p-3 border border-gray-300 rounded" required>
        <option value="">Select Role</option>
        <option value="voter">Voter</option>
        <option value="aspirant">Aspirant</option>
      </select>

      <!-- Seat selector, hidden by default -->
      <div id="seatDiv" class="hidden">
        <select id="seat" class="w-full p-3 border border-gray-300 rounded">
          <option value="">Select Seat</option>
          <option value="Chairperson">Chairperson</option>
          <option value="Assistant Chair">Assistant Chair</option>
          <option value="Treasurer">Treasurer</option>
          <option value="Assistant Treasurer">Assistant Treasurer</option>
          <option value="Secretary">Secretary</option>
          <option value="Assistant Secretary">Assistant Secretary</option>
        </select>
      </div>

      <input type="file" id="image" accept="image/*" class="w-full p-2 border rounded bg-white" required />

      <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded">
        Register
      </button>
    </form>
  </div>
</body>
</html>
